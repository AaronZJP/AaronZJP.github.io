<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>自定义转场动画（ViewController Transition） | Aaron的开发笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="什么是转场动画，转场动画就是从一个 Controller 跳转到另一个 Controller 时呈现的动画。在现在的iOS App 中很多 App 都实现了自己的转场动画，要知道自定义转场动画在 iOS7 以前是没有这么轻松的，在 iOS7 以前要想自定义转场动画那就只能自己去一步一步的实现，很久以前我隐约记得我看过一篇文章是关于自定义控制器容易器转场动画的，大概意思就是自定">
<meta property="og:type" content="article">
<meta property="og:title" content="自定义转场动画（ViewController Transition）">
<meta property="og:url" content="Aaronzjp.cn/2017/04/19/TransitionAnimation/index.html">
<meta property="og:site_name" content="Aaron的开发笔记">
<meta property="og:description" content="什么是转场动画，转场动画就是从一个 Controller 跳转到另一个 Controller 时呈现的动画。在现在的iOS App 中很多 App 都实现了自己的转场动画，要知道自定义转场动画在 iOS7 以前是没有这么轻松的，在 iOS7 以前要想自定义转场动画那就只能自己去一步一步的实现，很久以前我隐约记得我看过一篇文章是关于自定义控制器容易器转场动画的，大概意思就是自定">
<meta property="og:image" content="http://onocdmhtw.bkt.clouddn.com/20170419149260539056184.jpg">
<meta property="og:image" content="http://onocdmhtw.bkt.clouddn.com/20170419149261493436739.gif">
<meta property="og:image" content="http://onocdmhtw.bkt.clouddn.com/2017042014926613084706.png">
<meta property="og:image" content="http://onocdmhtw.bkt.clouddn.com/20170420149267110074263.gif">
<meta property="og:updated_time" content="2017-04-20T07:09:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="自定义转场动画（ViewController Transition）">
<meta name="twitter:description" content="什么是转场动画，转场动画就是从一个 Controller 跳转到另一个 Controller 时呈现的动画。在现在的iOS App 中很多 App 都实现了自己的转场动画，要知道自定义转场动画在 iOS7 以前是没有这么轻松的，在 iOS7 以前要想自定义转场动画那就只能自己去一步一步的实现，很久以前我隐约记得我看过一篇文章是关于自定义控制器容易器转场动画的，大概意思就是自定">
<meta name="twitter:image" content="http://onocdmhtw.bkt.clouddn.com/20170419149260539056184.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Aaron的开发笔记" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Aaron的开发笔记</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Stay foolish,Stay hungry!</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="Aaronzjp.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-TransitionAnimation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/19/TransitionAnimation/" class="article-date">
  <time datetime="2017-04-19T09:28:41.000Z" itemprop="datePublished">2017-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      自定义转场动画（ViewController Transition）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>什么是转场动画，转场动画就是从一个 Controller 跳转到另一个 Controller 时呈现的动画。在现在的iOS App 中很多 App 都实现了自己的转场动画，要知道自定义转场动画在 iOS7 以前是没有这么轻松的，在 iOS7 以前要想自定义转场动画那就只能自己去一步一步的实现，很久以前我隐约记得我看过一篇文章是关于自定义控制器容易器转场动画的，大概意思就是自定</p>
<a id="more"></a>
<p>义一个 <code>ContainerViewController</code> 将要转场的两个控制器放入到 <code>ContainerViewController</code> ，然后使用 <code>UIView</code> 的<code>+ (void)transitionFromView:(UIView *)fromView toView:(UIView *)toView duration:(NSTimeInterval)duration options:(UIViewAnimationOptions)options completion:(void (^)(BOOL finished))completion;</code> 方法，在该方法中去完成转场到操作，具体怎么做我也懒的去研究了，这里还是继续看一下 iOS7 提供的转场动画的 API 的使用。在 iOS7 之后苹果公开了一些接口可以让我们很轻松的来自定义转场动画。</p>
<h1 id="自定义转场动画"><a href="#自定义转场动画" class="headerlink" title="自定义转场动画"></a>自定义转场动画</h1><p>自定义转场动画总共的大概分为以下步骤：</p>
<ol>
<li>提供一个遵守 <code>&lt;UIViewControllerAnimatedTransitioning&gt;</code> 协议的<strong>动画控制器（Animation Controller）</strong>。在动画控制器中我们需要完成转场时间以及转场动画的提供。</li>
<li>提供一个遵守 <code>&lt;UIviewControllerInteractiveTransitioning&gt;</code> 协议的<strong>交互控制器（Interaction Controller）</strong>，该控制器其实不需要自己去实现，因为苹果已经提供了一个封装好了的交互控制器 <code>UIPercentDrivenInteractiveTransition</code> 。</li>
<li>自定义转场动画的控制器提供<strong>转场代理（Transition Delegate）</strong>，遵守代理的规则。</li>
</ol>
<p>转场代理目前来说有三种，分别对应了三种不同类型的转场情况，分别如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;UINavigationControllerDelegate&gt; //UINavigationController 的 delegate 属性遵守该协议。</div><div class="line">&lt;UIViewControllerTransitioningDelegate&gt; //UIViewController 的 transitioningDelegate 属性遵守该协议。</div><div class="line">&lt;UITabBarControllerDelegate&gt; //UITabBarController 的 delegate 属性遵守该协议。</div></pre></td></tr></table></figure>
<p>在转场动画发生的时候这三个协议中都分别有不同的方法要求我们提供一个动画控制器和一个交互控制器，这都是可选的。</p>
<p>除了上面说的这些以外还有两个会用到的那就是<strong>转场环境（Transition Context）</strong>和<strong>转场协调器（Transition Coordinator）</strong>，其中转场环境是必须的，转场环境遵守 <code>&lt;UIViewControllerContextTransitioning&gt;</code> 协议，不过这是系统提供给我们的，方便我们在转场时，获取转场中需要的数据。转场协调器目前我还没有具体的使用过，转场协调器遵守 <code>&lt;UIViewControllerTransitionCoordinator&gt;</code> 协议，可以通过控制器的 <code>transitionCoordinator</code> 属性获取转场协调器，不过它只在转场的过程中才会存在，如果处于非转场状态下该属性会返回 nil。</p>
<h1 id="开始Demo"><a href="#开始Demo" class="headerlink" title="开始Demo"></a>开始Demo</h1><h2 id="Push／Pop-转场"><a href="#Push／Pop-转场" class="headerlink" title="Push／Pop 转场"></a>Push／Pop 转场</h2><p>废话也不多说了，直接开始上代码。首先写一个 NavigationController 的 Push 和 Pop 的转场动画。</p>
<p>首先用 StoryBoard 快速的拖出两个控制器来。在我的 Demo 中根视图是一个 UITableViewController ，被 Push 的控制器是一个普通的 Controller。如图：</p>
<p><img src="http://onocdmhtw.bkt.clouddn.com/20170419149260539056184.jpg" alt="20170419149260539056184.jpg"></p>
<p>目前这个 Demo 就可以 Run 起来了，只不过动画是系统默认的，致于 Demo 中具体放什么东西就不说了，Demo 而已你想放啥就放啥。接下来我们开始自定义转场动画中需要的动画，就是<strong>动画控制器</strong>。</p>
<p>新建一个 PushAnimation 的类并遵守 <code>&lt;UIViewControllerAnimatedTransitioning&gt;</code> 协议如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//  PushAnimation.h</div><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface PushAnimation : NSObject &lt;UIViewControllerAnimatedTransitioning&gt;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">//  PushAnimation.m</div><div class="line"></div><div class="line">#import &quot;PushAnimation.h&quot;</div><div class="line">#import &quot;RootTableViewController.h&quot;</div><div class="line">#import &quot;RootDetailViewController.h&quot;</div><div class="line">#import &quot;RootTableViewCell.h&quot;</div><div class="line"></div><div class="line">@implementation PushAnimation</div><div class="line"></div><div class="line">- (NSTimeInterval)transitionDuration:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">    return 0.5;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)animateTransition:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">  	//通过转场环境获取 fromVC 和 toVC。</div><div class="line">    RootTableViewController *fromVC = (RootTableViewController *)[transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];</div><div class="line">    RootDetailViewController *toVC = (RootDetailViewController *)[transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</div><div class="line">    </div><div class="line">  	//获取 fromVC 中被选中的 Cell</div><div class="line">  	RootTableViewCell *cell = [fromVC.tableView cellForRowAtIndexPath:fromVC.currentIndexPath];</div><div class="line">    </div><div class="line">  	//通过转场环境获取 容器视图</div><div class="line">    UIView *containerView = [transitionContext containerView];</div><div class="line">    </div><div class="line">  	//获取 Cell 中 headerView 的截图</div><div class="line">  	UIView *cellImageView = [cell.headerView snapshotViewAfterScreenUpdates:NO];</div><div class="line">    </div><div class="line">  	//将获取到的 cell 的 headerView 的截图的 frame 转换成当前容器视图的位置</div><div class="line">  	cellImageView.frame = [cell.headerView convertRect:cell.headerView.bounds toView:containerView];</div><div class="line">    </div><div class="line">  	//设置转场前初始的状态</div><div class="line">    toVC.view.alpha = 0;</div><div class="line">    cell.headerView.hidden = YES;</div><div class="line">    toVC.headerImageView.hidden = YES;</div><div class="line">    </div><div class="line">  	//把需要参与到转场动画中的视图添加到容器视图中</div><div class="line">    [containerView addSubview:toVC.view];</div><div class="line">    [containerView addSubview:cellImageView];</div><div class="line">    </div><div class="line">  	//转场动画开始</div><div class="line">    [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^&#123;</div><div class="line">		//需要更新布局 否则在横屏状态下 cellImageView 位置不正确</div><div class="line">        [containerView layoutIfNeeded];</div><div class="line">        cellImageView.frame = [toVC.headerImageView convertRect:toVC.headerImageView.bounds toView:containerView];</div><div class="line">        toVC.view.alpha = 1;</div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">        [cellImageView removeFromSuperview];</div><div class="line">        toVC.headerImageView.hidden = NO;</div><div class="line">        cell.headerView.hidden = NO;</div><div class="line">      	//动画结束后必须要向 Context 调用该方法通知动画结束，这里可以直接返回YES，如果动画有手势参与到话最好不要直接返回YES</div><div class="line">       [transitionContext completeTransition:YES];</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p> <code>&lt;UIViewControllerAnimatedTransitioning&gt;</code> 协议主要有两个方法：</p>
<p><code>- (NSTimeInterval)transitionDuration:(nullable id &lt;UIViewControllerContextTransitioning&gt;)transitionContext;</code></p>
<p>该方法返回一个 <code>NSTimeInterval</code> ，即转场动画的时间长度，确定转场动画所需要的时间。在该方法中系统还提供了一个上文中提到的<strong>转场环境</strong>。</p>
<p><code>- (void)animateTransition:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext;</code></p>
<p>该方法没有返回值，同时也为我们提供了转场环境，转场的动画就需要在这个方法里面来完成。这里得说下 fromVc 和 toVC ，这两个是一个相对的概念，就是说当前正在显示的 Controller 就是 fromVC ，将要转场过去的 Controller 就是 toVC。</p>
<p>上面讲到的自定义转场动画的步骤到这已经完成了第一步，但是现在先跳过第二部，暂时不添加交互控制器到我们的转场动画中来，先完成转场动画后再添加。现在进入到第三步，遵守转场动画协议，为转场动画提供代理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//  RootTableViewController.h</div><div class="line"></div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface RootTableViewController : UITableViewController</div><div class="line">//这个属性就是用来记录被选中的Cell的，在上面动画控制器中就通过这个属性来获取的Cell</div><div class="line">@property (nonatomic,strong) NSIndexPath *currentIndexPath;</div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">//  RootTableViewController.m</div><div class="line"></div><div class="line">#import &quot;RootTableViewController.h&quot;</div><div class="line">#import &quot;PushAnimation.h&quot;</div><div class="line"></div><div class="line">@interface RootTableViewController () &lt;UINavigationControllerDelegate&gt;</div><div class="line">...</div><div class="line">@property (nonatomic,strong) PushAnimation *pushAnimation;</div><div class="line">...</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation RootTableViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">  	...</div><div class="line">    ...</div><div class="line">    self.pushAnimation = [PushAnimation new];</div><div class="line">    self.navigationController.delegate = self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - Table view data source</div><div class="line"></div><div class="line">...</div><div class="line">...</div><div class="line"></div><div class="line">#pragma mark - Table view data delegate</div><div class="line"></div><div class="line">...</div><div class="line">...</div><div class="line"></div><div class="line">#pragma mark - UINavigationControllerDelegate</div><div class="line"></div><div class="line">// 1.转场协议，返回一个 遵守 UIViewControllerAnimatedTransitioning 协议的类。（就是动画控制器）</div><div class="line">- (id&lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController animationControllerForOperation:(UINavigationControllerOperation)operation fromViewController:(UIViewController *)fromVC toViewController:(UIViewController *)toVC &#123;</div><div class="line">    if (operation == UINavigationControllerOperationPush) &#123;</div><div class="line">        return _pushAnimation;</div><div class="line">    &#125; else &#123;</div><div class="line">	    return nil;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成了上面的这些，现在这个 Demo 在 Push 的时候就已经是我们的自定义的转场动画了。测试一下，没问题。 Pop 动画呢这里就不详细说太多了，和 Push 是一样的，写个动画控制器，在转场协议的方法中（上面代码中标为1的那个方法）判断一下，返回一个 Pop 的动画控制器就可以了。</p>
<h2 id="添加交互控制器"><a href="#添加交互控制器" class="headerlink" title="添加交互控制器"></a>添加交互控制器</h2><p>上面已经讲了系统已经为我们封装好了一个交互控制器，我们继承这个类就可以了。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//  SwipInteractiveTransition.h</div><div class="line"></div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface SwipInteractiveTransition : UIPercentDrivenInteractiveTransition</div><div class="line">//该属性用来记录是否处于交互中，后面会用到这个属性</div><div class="line">@property (nonatomic,assign) BOOL interacting;</div><div class="line">//添加一个添加手势的方法</div><div class="line">- (void)addGestureInViewController:(UIViewController *)controller;</div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">//  SwipInteractiveTransition.m</div><div class="line"></div><div class="line">#import &quot;SwipInteractiveTransition.h&quot;</div><div class="line"></div><div class="line">@interface SwipInteractiveTransition ()</div><div class="line">//该属性用来持有被添加手势的控制器，因为后面手势触发的时候要用改控制器Pop回去</div><div class="line">@property (nonatomic,strong) UIViewController *pushingViewController;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation SwipInteractiveTransition</div><div class="line"></div><div class="line">- (void)addGestureInViewController:(UIViewController *)controller &#123;</div><div class="line">  	self.pushingViewController = controller;</div><div class="line">    [self prepareGesture];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)prepareGesture &#123;</div><div class="line">   	UIScreenEdgePanGestureRecognizer *gesture = [[UIScreenEdgePanGestureRecognizer alloc]initWithTarget:self action:@selector(handleGesture:)];</div><div class="line">  	//设置手势方向</div><div class="line">    gesture.edges = UIRectEdgeLeft;</div><div class="line">  	//添加手势到控制器的View</div><div class="line">    [self.pushingViewController.view addGestureRecognizer:gesture];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)handleGesture:(UIPanGestureRecognizer *)gesture &#123;</div><div class="line">  	//获取手势在View中当前的位置</div><div class="line">    CGPoint traslation = [gesture translationInView:self.pushingViewController.view];</div><div class="line">  	//计算进度，这里按照当前控制器的宽来计算。</div><div class="line">    CGFloat progress = traslation.x / CGRectGetWidth(self.pushingViewController.view.bounds);</div><div class="line">  	//手势开始</div><div class="line">    if (gesture.state == UIGestureRecognizerStateBegan) &#123;</div><div class="line">      	//设置该属性，标记转场正在进行</div><div class="line">        self.interacting = YES;</div><div class="line">      	//Pop当前控制器</div><div class="line">        [self.pushingViewController.navigationController popViewControllerAnimated:YES];</div><div class="line">    //手势状态变化</div><div class="line">    &#125; else if (gesture.state == UIGestureRecognizerStateChanged) &#123;</div><div class="line">      	//更新手势控制器进度</div><div class="line">        [self updateInteractiveTransition:progress];</div><div class="line">    //手势结束或者取消的时候</div><div class="line">    &#125; else if (gesture.state == UIGestureRecognizerStateEnded || gesture.state == UIGestureRecognizerStateCancelled) &#123;</div><div class="line">      	//标记转场结束</div><div class="line">        self.interacting = NO;</div><div class="line">      	//如果进去大于50%就完成转场，否则取消转场</div><div class="line">        if (progress &gt; 0.5) &#123;</div><div class="line">            [self finishInteractiveTransition];</div><div class="line">        &#125; else &#123;</div><div class="line">            [self cancelInteractiveTransition];</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">      	//对其他情况的处理</div><div class="line">        self.interacting = NO;</div><div class="line">        [self cancelInteractiveTransition];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>做到这一步的时候手势控制器也完成了，那么如何把手势控制器添加到 Controller 并生效使用手势来进行转场？继续往下看。😄 这里回到 <code>RootDetailViewController</code> 这个类，遵守 <code>&lt;UINavigationControllerDelegate&gt;</code> 代理，实现该代理中的另一个方法即可。其实这里添加在那个控制器都可以的，但是这里还是添加到 <code>RootDetailViewController</code> 吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">//  RootDetailViewController.m</div><div class="line"></div><div class="line">#import &quot;RootDetailViewController.h&quot;</div><div class="line">#import &quot;PopAnimation.h&quot;</div><div class="line">#import &quot;SwipInteractiveTransition.h&quot;</div><div class="line">#import &quot;PushAnimation.h&quot;</div><div class="line"></div><div class="line">@interface RootDetailViewController () &lt;UINavigationControllerDelegate&gt;</div><div class="line">@property (nonatomic,strong) UIPercentDrivenInteractiveTransition *interactiveControler;</div><div class="line">@property (nonatomic,strong) SwipInteractiveTransition *swipInteractiveController;</div><div class="line">@property (nonatomic,strong) PopAnimation *popAnimation;</div><div class="line">@property (nonatomic,strong) PushAnimation *pushAnimation;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation RootDetailViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    _headerImageView.image = _image;</div><div class="line">    _textView.text = _text;</div><div class="line">    </div><div class="line">    self.popAnimation = [PopAnimation new];</div><div class="line">    self.pushAnimation = [PushAnimation new];</div><div class="line">    </div><div class="line">    self.swipInteractiveController = [SwipInteractiveTransition new];</div><div class="line">    [self.swipInteractiveController addGestureInViewController:self];</div><div class="line">    self.navigationController.delegate = self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id&lt;UIViewControllerAnimatedTransitioning&gt;)navigationController:(UINavigationController *)navigationController animationControllerForOperation:(UINavigationControllerOperation)operation fromViewController:(UIViewController *)fromVC toViewController:(UIViewController *)toVC &#123;</div><div class="line">    if (operation == UINavigationControllerOperationPop) &#123;</div><div class="line">        return _popAnimation;</div><div class="line">    &#125; else if (operation == UINavigationControllerOperationPush) &#123;</div><div class="line">        return _pushAnimation;</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line">//在该方法中返回手势控制器即可</div><div class="line">- (id&lt;UIViewControllerInteractiveTransitioning&gt;)navigationController:(UINavigationController *)navigationController interactionControllerForAnimationController:(id&lt;UIViewControllerAnimatedTransitioning&gt;)animationController &#123;</div><div class="line">    return self.swipInteractiveController.interacting ? self.swipInteractiveController : nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>完成后的效果如下：</p>
<p><img src="http://onocdmhtw.bkt.clouddn.com/20170419149261493436739.gif" alt="20170419149261493436739.gif"></p>
<p>这里可能手势取消后到动画有点问题（如果谁知道原因可以告诉我一下，谢谢😁），模拟器上动画表现的不是很好，后面我会把代码上传到Github，可以下载源码在真机上测试。</p>
<h2 id="Modal转场"><a href="#Modal转场" class="headerlink" title="Modal转场"></a>Modal转场</h2><p>普通的 Modal 转场就不详细的解释Demo，因为其实和 Push／Pop 转场是差不多的，只是转场代理不一样。 Modal 转场遵守 <code>&lt;UIViewControllerTransitioningDelegate&gt;</code> 协议，协议中的方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//提供 Present 时的动画控制器</div><div class="line">- (nullable id &lt;UIViewControllerAnimatedTransitioning&gt;)animationControllerForPresentedController:(UIViewController *)presented presentingController:(UIViewController *)presenting sourceController:(UIViewController *)source;</div><div class="line">//提供 Dismiss 时的动画控制器</div><div class="line">- (nullable id &lt;UIViewControllerAnimatedTransitioning&gt;)animationControllerForDismissedController:(UIViewController *)dismissed;</div><div class="line">//提供 Present 时的交互控制器</div><div class="line">- (nullable id &lt;UIViewControllerInteractiveTransitioning&gt;)interactionControllerForPresentation:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animator;</div><div class="line">//提供 Dismiss 时的交互控制器</div><div class="line">- (nullable id &lt;UIViewControllerInteractiveTransitioning&gt;)interactionControllerForDismissal:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animator;</div><div class="line"></div><div class="line">//该方法是在 iOS8 之后提供的，其作用就是现在要讲的。</div><div class="line">- (nullable UIPresentationController *)presentationControllerForPresentedViewController:(UIViewController *)presented presentingViewController:(nullable UIViewController *)presenting sourceViewController:(UIViewController *)source;</div></pre></td></tr></table></figure>
<p>在 Modal 转场中除了平时默认的动画外其实系统也默认的提供了其他四种的转场动画，设置控制器的 <code>modalTransitionStyle</code> 属性就可以很方便的使用这四种默认的转场动画，分别如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">UIModalTransitionStyleCoverVertical</div><div class="line">UIModalTransitionStyleFlipHorizontal </div><div class="line">UIModalTransitionStyleCrossDissolve</div><div class="line">UIModalTransitionStylePartialCurl</div></pre></td></tr></table></figure>
<p>但是很多时候还是并不能满足对转场动画的需求，所以这里就需要自定义转场动画了。</p>
<p>自定义转场动画需要在 ViewController 的 <code>modalPresentationStyle</code> 分别为 <code>UIModalPresentationCustom</code> 和 <code>UIModalPresentationFullScreen</code> 的时候才可以自定义转场动画，同时 ViewController 指定的 <code>modalTransitionStyle</code> 转场动画将会被忽略。</p>
<p><code>UIModalPresentationCustom</code> 和 <code>UIModalPresentationFullScreen</code> 之间也是有差别的，这点需要特别的注意，不然很有可能在后面的自定义转场动画中踩坑。</p>
<ul>
<li>UIModalPresentationFullScreen 模式：presentation 后，presentingView 被主动移出视图结构，在 dismissal 中 presentingView 是 toView 的角色，其将会重新加入 containerView 中。</li>
<li>UIModalPresentationCustom 模式：转场时 containerView 并不担任 presentingView 的父视图，后者由 UIKit 另行管理。在 presentation 后，fromView(presentingView) 未被移出视图结构，在 dismissal 中，注意不要像其他转场中那样将 toView(presentingView) 加入 containerView 中，否则本来可见的 presentingView 将会被移除出自身所处的视图结构消失不见。这点在 Custom 模式下要特别注意。</li>
</ul>
<p>在 iOS8 之后 Modal 转场代理中新增了上面的第4个方法，可以提供一个 <code>UIPresentationController</code> ，这个类为模态视图的转场提供了更好的解决方案，可以更加深入的自定义 PresentedViewController ，比如 PresentedView 的尺寸大小，背景等，这个其实也可以在不需要转场动画的情况下单独使用。其中还有最重要的一个功能，那就是对屏幕布局的管理，这里就不展开学习了，后面单独去学习关于这个的使用。</p>
<p>现在我要自定义一个像 iOS 10 中 Music App中，播放界面弹出的效果（其实 Demo 中的效果并不是很像，只能说差不多吧😅）。如图：</p>
<p><img src="http://onocdmhtw.bkt.clouddn.com/2017042014926613084706.png" alt="2017042014926613084706.png"></p>
<p>首先还是先提供一个 Modal 转场的动画控制器吧，关于动画控制器上面也详细说过了，就是一个遵守 <code>&lt;UIViewControllerAnimatedTransitioning&gt;</code> 协议的对象，这里就直接贴上代码了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">//  PresentAnimation.h</div><div class="line"></div><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">typedef NS_ENUM(NSInteger,AnimationType) &#123;</div><div class="line">    AnimationTypeOfPresent = 0,</div><div class="line">    AnimationTypeOfPop</div><div class="line">&#125;;</div><div class="line"></div><div class="line">@interface PresentAnimation : NSObject &lt;UIViewControllerAnimatedTransitioning&gt;</div><div class="line"></div><div class="line">+ (instancetype)animationUseAnimationType:(AnimationType)type;</div><div class="line">- (instancetype)initWithAnimationType:(AnimationType)type;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>在这个控制器里，我直接把两个动画写到了一起，<code>type</code> 的不同去获取 present 或者 dismiss 对应的动画。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">//  PresentAnimation.m</div><div class="line"></div><div class="line">#import &quot;PresentAnimation.h&quot;</div><div class="line">#import &quot;PresentedViewController.h&quot;</div><div class="line"></div><div class="line">@interface PresentAnimation ()</div><div class="line">@property (nonatomic,assign) AnimationType type;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation PresentAnimation</div><div class="line"></div><div class="line">+ (instancetype)animationUseAnimationType:(AnimationType)type &#123;</div><div class="line">    return [[self alloc]initWithAnimationType:type];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithAnimationType:(AnimationType)type &#123;</div><div class="line">    self = [super init];</div><div class="line">    if (self) &#123;</div><div class="line">        _type = type;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSTimeInterval)transitionDuration:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">    return 0.5;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)animateTransition:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">    switch (self.type) &#123;</div><div class="line">        case AnimationTypeOfPresent:</div><div class="line">            [self doPresentAnimation:transitionContext];</div><div class="line">            break;</div><div class="line">        case AnimationTypeOfPop:</div><div class="line">            [self doDisMissAnimation:transitionContext];</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)doPresentAnimation:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">    UIViewController *toVC = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</div><div class="line">    toVC.view.transform = CGAffineTransformScale(CGAffineTransformIdentity, 0.01, 0.01);</div><div class="line">    UIView *containerView = [transitionContext containerView];</div><div class="line">    [containerView addSubview:toVC.view];</div><div class="line">    [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^&#123;</div><div class="line">        toVC.view.transform = CGAffineTransformIdentity;</div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">        [transitionContext completeTransition:YES];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)doDisMissAnimation:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext &#123;</div><div class="line">    UIViewController *fromVC = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];</div><div class="line">    UIView *toView = [transitionContext viewForKey:UITransitionContextToViewKey];</div><div class="line">    </div><div class="line">    UIView *containerView = [transitionContext containerView];</div><div class="line">    [containerView insertSubview:toView belowSubview:fromVC.view];</div><div class="line">    [containerView addSubview:fromVC.view];</div><div class="line">    </div><div class="line">    [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^&#123;</div><div class="line">        fromVC.view.transform = CGAffineTransformScale(CGAffineTransformIdentity, 0.01, 0.01);</div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">        [transitionContext completeTransition:![transitionContext transitionWasCancelled]];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>动画控制器完成后这里回到 presentingViewController ，在这个 presentingViewController 中遵守转场协议，提供转场需要的动画控制器。在 Demo 中还是在 <code>RootTableViewController</code> 这个控制器中进行的模态转场的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">//  RootTableViewController.m</div><div class="line"></div><div class="line">#import &quot;RootTableViewController.h&quot;</div><div class="line"></div><div class="line">@interface RootTableViewController () &lt;UIViewControllerTransitioningDelegate&gt;</div><div class="line">...</div><div class="line">...</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation RootTableViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">  	...</div><div class="line">    ...</div><div class="line">    self.pushAnimation = [PushAnimation new];</div><div class="line">    self.navigationController.delegate = self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - Table view data source</div><div class="line"></div><div class="line">...</div><div class="line">...</div><div class="line"></div><div class="line">#pragma mark - Table view data delegate</div><div class="line">...</div><div class="line">//这里我时在一个 TableViewController 中演示各种转场动画的，所以在这里进行 present 操作</div><div class="line">- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath &#123;</div><div class="line">  [tableView deselectRowAtIndexPath:indexPath animated:YES];</div><div class="line">  //通过 MainStoryboard 初始化控制器</div><div class="line">  UIStoryboard *board = [UIStoryboard storyboardWithName:@&quot;Main&quot; bundle:nil];</div><div class="line">  HalfPresentedViewController *presentVC = [board  instantiateViewControllerWithIdentifier:@&quot;customOfPresentattionVC&quot;];</div><div class="line">  //将 presented 的模态转场设置为自定义</div><div class="line">  presentVC.modalPresentationStyle = UIModalPresentationCustom;</div><div class="line">  //添加 UIViewControllerTransitioningDelegate 协议的代理</div><div class="line">  presentVC.transitioningDelegate = self;</div><div class="line">  [self presentViewController:presentVC animated:YES completion:nil];</div><div class="line">&#125;</div><div class="line">...</div><div class="line"></div><div class="line">#pragma mark - UIViewControllerTransitioningDelegate</div><div class="line"></div><div class="line">//返回 Present 时的动画控制器</div><div class="line">- (id&lt;UIViewControllerAnimatedTransitioning&gt;)animationControllerForPresentedController:(UIViewController *)presented presentingController:(UIViewController *)presenting sourceController:(UIViewController *)source &#123;</div><div class="line">    return [PresentAnimation animationUseAnimationType:AnimationTypeOfPresent];</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回 Dismiss 时的动画控制器</div><div class="line">- (id&lt;UIViewControllerAnimatedTransitioning&gt;)animationControllerForDismissedController:(UIViewController *)dismissed &#123;</div><div class="line">    return [PresentAnimation animationUseAnimationType:AnimationTypeOfPop];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成这步后 run 一下 Demo ，嗯没问题。这其实就是自定义了 Model的转场动画了。但是这时候 presented 还是一个全屏的方式呈现出来的。不过下面就开始自定义 preseted 这个视图了，自定义 preseted 就需要遵守上面提到的  <code>&lt;UIViewControllerTransitioningDelegate&gt;</code> 代理中的最后一个方法，为其提供一个 <code>PresentationController</code> 。</p>
<p>接下来开始自定义 <code>PresentationController</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//  CustomPresentationController.h</div><div class="line"></div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface CustomPresentationController : UIPresentationController</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">//  CustomPresentationController.m</div><div class="line">//  Test</div><div class="line">//</div><div class="line">//  Created by Aaron Zhang on 12/04/2017.</div><div class="line">//  Copyright © 2017 张近坪. All rights reserved.</div><div class="line">//</div><div class="line"></div><div class="line">#import &quot;CustomPresentationController.h&quot;</div><div class="line"></div><div class="line">@interface CustomPresentationController ()</div><div class="line">//该视图时作为上面图中那个黑色半透明的背景的</div><div class="line">@property (nonatomic,strong) UIView *backView;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation CustomPresentationController</div><div class="line"></div><div class="line">- (void)presentationTransitionWillBegin &#123;</div><div class="line">    </div><div class="line">    self.backView = [[UIView alloc]init];</div><div class="line">    self.backView.frame = self.containerView.bounds;</div><div class="line">    self.backView.backgroundColor = [UIColor blackColor];</div><div class="line">    self.backView.alpha = 0.0;</div><div class="line">  	</div><div class="line">  	//获取当前转场的容器视图并添加要转场视图到容器</div><div class="line">    [self.containerView insertSubview:self.backView atIndex:0];</div><div class="line">    [self.containerView addSubview:self.presentedView];</div><div class="line">    </div><div class="line">  	//在转场中做动画这里就用到了上面提到的 转场协调器，如果不通过转场协调器来做动画，可能转场的时候动画不同步</div><div class="line">    id &lt;UIViewControllerTransitionCoordinator&gt; transitionCoordinator = self.presentingViewController.transitionCoordinator;</div><div class="line">    [transitionCoordinator animateAlongsideTransition:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) &#123;</div><div class="line">        _backView.alpha = 0.5;</div><div class="line">        self.presentingViewController.view.transform = CGAffineTransformScale(self.presentingViewController.view.transform, 0.98, 0.98);</div><div class="line">    &#125; completion:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) &#123;</div><div class="line">        </div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">//在 present 失败的时候移除背景半透明视图</div><div class="line">- (void)presentationTransitionDidEnd:(BOOL)completed &#123;</div><div class="line">    if (!completed) &#123;</div><div class="line">        [_backView removeFromSuperview];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)dismissalTransitionWillBegin &#123;</div><div class="line">    id &lt;UIViewControllerTransitionCoordinator&gt; transitionCoordinator = self.presentingViewController.transitionCoordinator;</div><div class="line">    [transitionCoordinator animateAlongsideTransition:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) &#123;</div><div class="line">        _backView.alpha = 0.0;</div><div class="line">        self.presentingViewController.view.transform = CGAffineTransformIdentity;</div><div class="line">    &#125; completion:^(id&lt;UIViewControllerTransitionCoordinatorContext&gt;  _Nonnull context) &#123;</div><div class="line">        </div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">////在 present 结束的时候移除背景半透明视图</div><div class="line">- (void)dismissalTransitionDidEnd:(BOOL)completed &#123;</div><div class="line">    if (completed) &#123;</div><div class="line">        [_backView removeFromSuperview];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//该方法返回 PresentedView 在容器中的frame ，就是在这里修改 presentedView 视图大小的。</div><div class="line">- (CGRect)frameOfPresentedViewInContainerView &#123;</div><div class="line">    return CGRectMake(10, self.containerView.bounds.size.height / 2, self.containerView.bounds.size.width - 20, self.containerView.bounds.size.height / 2 - 10);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//容器视图重新布局子视图，在我的这个Demo中必须做这一步的操作，否则上面方法返回的 presentedView 的 frame 不会生效，目前我也不是特别清楚原因。</div><div class="line">- (void)containerViewWillLayoutSubviews &#123;</div><div class="line">    self.backView.frame = self.containerView.bounds;</div><div class="line">    self.presentedView.frame = [self frameOfPresentedViewInContainerView];</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回 presentedView 视图。</div><div class="line">- (UIView *)presentedView &#123;</div><div class="line">    UIView *presentedView = self.presentedViewController.view;</div><div class="line">    presentedView.layer.cornerRadius = 8;</div><div class="line">    return presentedView;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>PresentationController</code> 就完成了，在这中主要重写了在 <code>PresentationController</code> 不同状态下的方法，来自定义 <code>PresentationController</code> 的呈现。接下来只需要回到刚刚的 presentedViewController 中，在这个类  <code>RootTableViewController</code> 中通过 <code>&lt;UIViewControllerTransitioningDelegate&gt;</code> 返回自定义的  <code>PresentationViewController</code> 就好了，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">//  RootTableViewController.m</div><div class="line"></div><div class="line">#import &quot;RootTableViewController.h&quot;</div><div class="line"></div><div class="line">@interface RootTableViewController () &lt;UIViewControllerTransitioningDelegate&gt;</div><div class="line">...</div><div class="line">...</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation RootTableViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">  	...</div><div class="line">    ...</div><div class="line">    self.pushAnimation = [PushAnimation new];</div><div class="line">    self.navigationController.delegate = self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#pragma mark - Table view data source</div><div class="line">...</div><div class="line">...</div><div class="line"></div><div class="line">#pragma mark - Table view data delegate</div><div class="line">...</div><div class="line">...</div><div class="line"></div><div class="line">#pragma mark - UIViewControllerTransitioningDelegate</div><div class="line">...</div><div class="line"></div><div class="line">...</div><div class="line">//提供自定义的 UIPresentationController</div><div class="line">- (UIPresentationController *)presentationControllerForPresentedViewController:(UIViewController *)presented presentingViewController:(UIViewController *)presenting sourceViewController:(UIViewController *)source &#123;</div><div class="line">    CustomPresentationController *myPresentationController = [[CustomPresentationController alloc]initWithPresentedViewController:presented presentingViewController:presenting];</div><div class="line">    return myPresentationController;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成后最终的效果如下：</p>
<p><img src="http://onocdmhtw.bkt.clouddn.com/20170420149267110074263.gif" alt="20170420149267110074263.gif"></p>
<p><a href="https://github.com/AaronZJP/iOS-Basic-Demos/tree/master/ViewControllerTrasnsition/Test" target="_blank" rel="external">Demo</a></p>
<p>参考资料：</p>
<p><a href="https://developer.apple.com/library/content/featuredarticles/ViewControllerPGforiPhoneOS/index.html#//apple_ref/doc/uid/TP40007457-CH2-SW1" target="_blank" rel="external">View Controller Programming Guide for iOS</a></p>
<p><a href="https://developer.apple.com/library/content/samplecode/LookInside/Introduction/Intro.html" target="_blank" rel="external">Presentation Controllers, Adaptivity, and Custom Animator Objects</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="Aaronzjp.cn/2017/04/19/TransitionAnimation/" data-id="cj3n5tn6b00197st5u9d3wiy3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/03/27/Swift-Initialization/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Swift-构造过程</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Core-Animation/">Core Animation</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Swift/">Swift</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/UI/">UI</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS网络编程/">iOS网络编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/runtime/">runtime</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/多线程技术/">多线程技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/小技巧/">小技巧</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储/">数据存储</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库（DataBase）/">数据库（DataBase）</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/疑难杂症/">疑难杂症</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Animation/">Animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AutoLayout/">AutoLayout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Autolayout/">Autolayout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CALayer/">CALayer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Core-Animation/">Core Animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KVO-KVC/">KVO/KVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQLite/">SQLite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/">Swift</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift基础/">Swift基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UIKit/">UIKit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UINavigationBar/">UINavigationBar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/block/">block</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS多线程/">iOS多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS开发思路/">iOS开发思路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/runtime/">runtime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/runtime​/">runtime​</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/self-sizing-TableView-Cells/">self-sizing TableView Cells</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/其他/">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图层/">图层</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/坑/">坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小坑/">小坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据存储/">数据存储</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据持久化/">数据持久化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件管理/">文件管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/本地化/">本地化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/构造过程/">构造过程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/枚举/">枚举</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自动布局/">自动布局</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自适应Cell/">自适应Cell</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Animation/" style="font-size: 10px;">Animation</a> <a href="/tags/AutoLayout/" style="font-size: 10px;">AutoLayout</a> <a href="/tags/Autolayout/" style="font-size: 10px;">Autolayout</a> <a href="/tags/CALayer/" style="font-size: 10px;">CALayer</a> <a href="/tags/Core-Animation/" style="font-size: 10px;">Core Animation</a> <a href="/tags/KVO-KVC/" style="font-size: 10px;">KVO/KVC</a> <a href="/tags/SQLite/" style="font-size: 10px;">SQLite</a> <a href="/tags/Swift/" style="font-size: 15px;">Swift</a> <a href="/tags/Swift基础/" style="font-size: 10px;">Swift基础</a> <a href="/tags/UIKit/" style="font-size: 10px;">UIKit</a> <a href="/tags/UINavigationBar/" style="font-size: 10px;">UINavigationBar</a> <a href="/tags/block/" style="font-size: 10px;">block</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/iOS多线程/" style="font-size: 10px;">iOS多线程</a> <a href="/tags/iOS开发思路/" style="font-size: 15px;">iOS开发思路</a> <a href="/tags/runtime/" style="font-size: 20px;">runtime</a> <a href="/tags/runtime​/" style="font-size: 10px;">runtime​</a> <a href="/tags/self-sizing-TableView-Cells/" style="font-size: 10px;">self-sizing TableView Cells</a> <a href="/tags/其他/" style="font-size: 10px;">其他</a> <a href="/tags/动画/" style="font-size: 10px;">动画</a> <a href="/tags/图层/" style="font-size: 10px;">图层</a> <a href="/tags/坑/" style="font-size: 10px;">坑</a> <a href="/tags/小坑/" style="font-size: 10px;">小坑</a> <a href="/tags/数据存储/" style="font-size: 15px;">数据存储</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据持久化/" style="font-size: 10px;">数据持久化</a> <a href="/tags/文件管理/" style="font-size: 10px;">文件管理</a> <a href="/tags/本地化/" style="font-size: 15px;">本地化</a> <a href="/tags/构造过程/" style="font-size: 10px;">构造过程</a> <a href="/tags/枚举/" style="font-size: 10px;">枚举</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/自动布局/" style="font-size: 10px;">自动布局</a> <a href="/tags/自适应Cell/" style="font-size: 10px;">自适应Cell</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/19/TransitionAnimation/">自定义转场动画（ViewController Transition）</a>
          </li>
        
          <li>
            <a href="/2017/03/27/Swift-Initialization/">Swift-构造过程</a>
          </li>
        
          <li>
            <a href="/2017/03/22/Swift-Method/">Swift-方法</a>
          </li>
        
          <li>
            <a href="/2017/03/07/Animation/">iOS动画</a>
          </li>
        
          <li>
            <a href="/2016/12/01/iOS-CALayer/">初识CALayer</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Aaron_36<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>